<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Alive Status â€” Stagger In/Out (No Zoom, No Scroll)</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --row-w: 366px;   /* will be updated to wood.png natural width */
      --row-h: 48px;    /* will be updated to wood.png natural height */
      --shift-x: 0px;   /* = (row-w - 366px) to keep columns aligned */
    }
    html, body {
      margin: 0; padding: 0; background: transparent; overflow: hidden;
      width: 100%; height: 100%; font-family: 'Montserrat', sans-serif;
    }
    .stage { position:relative; width:1920px; height:1080px; overflow:hidden; background:transparent; }
    .alive-panel { position:absolute; left:1519px; top:263px; width:404px; height:827px; overflow:hidden; background:transparent; }

    /* Header bar (panel-relative 1609,264 -> 90,11) */
    .header{
      position:absolute; left:90px; top:11px; width:323px; height:23px;
      background:rgba(0,0,0,0.6);
      z-index:2;
    }
    /* Header labels with exact offsets */
    .hdr-label{
      position:absolute; font-weight:700; text-transform:uppercase; font-size:14px; color:#ff0;
      height:23px; line-height:23px;
    }
    .hdr-label.squad  { left:10px;   top:0px;  width:67px; }
    .hdr-label.finish { left:139px; top:2px;  width:53px; height:18px; line-height:18px; }
    .hdr-label.alive  { left:240px; top:0px;  width:48px; height:18px; line-height:18px; }

    /* Rows start (panel-relative 1554,288 -> 35,35) */
    .rows { position:absolute; left:35px; top:35px; width:var(--row-w); }

    /* Wooden plank row */
    .team { position:relative; width:var(--row-w); height:var(--row-h); margin:0; }
    .team + .team{ margin-top:0; }

    /* Wood image element to avoid CSS zoom/crop */
    .wood-bg{ position:absolute; inset:0; width:100%; height:100%; object-fit:fill; z-index:0; }
    .team-content{ position:absolute; inset:0; z-index:1; color:#fff; box-sizing:border-box; }

    /* Element positions inside plank (shifted if the plank is wider than 366) */
    .team-logo  { position:absolute; left:calc(31px + var(--shift-x)); top:5px;  width:40px; height:40px; object-fit:contain; }
    .team-name  { position:absolute; left:calc(76px + var(--shift-x)); top:17px; width:105px; height:25px; line-height:25px;
                  font-size:18.99px; font-weight:700; text-transform:uppercase; color:#eac278;
                  white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .kills      { position:absolute; left:calc(205px + var(--shift-x)); top:17px; font-size:18.99px; font-weight:700; width:38px; height:25px; line-height:25px; text-align:center; }
    .status-icons { position:absolute; left:calc(272px + var(--shift-x)); top:14px; display:flex; gap:4px; }
    .status-icons img { width:20px; height:20px; }

    /* --- Staggered animations --- */
    @keyframes rowIn { from{ opacity:0; transform: translateY(10px); } to{ opacity:1; transform: translateY(0); } }
    @keyframes rowOut { from{ opacity:1; transform: translateY(0); } to{ opacity:0; transform: translateY(-10px); } }
@keyframes rowOutUp { from { opacity:1; transform: translateY(0); } to { opacity:0; transform: translateY(-10px); } }
@keyframes rowChange { 0%{ opacity:0.2; transform: translateY(10px); } 100%{ opacity:1; transform: translateY(0); } }
    /* Data-change animation, isolated via a class so exit stays intact */
    .team.changed .team-content { animation: rowChange .6s cubic-bezier(0.16, 1, 0.3, 1); }
    /* When exiting, suppress any child change animation to avoid conflicts */
    .team.exit .team-content { animation: none !important; }

    .enter {
      animation-name: rowIn;
      animation-duration: 260ms;
      animation-timing-function: ease-out;
      animation-fill-mode: both;
      animation-delay: var(--d, 0ms); /* set per-row */
    }
    .exit {
      animation-name: rowOutUp !important;
      animation-duration: 220ms;
      animation-timing-function: ease-in;
      animation-fill-mode: both;
      animation-delay: var(--d, 0ms); /* set per-row */
    }
  </style>
</head>
<body>
  <div class="stage">
    <div id="overlayRoot" class="alive-panel" style="display:block;">
      <!-- Header -->
      <div class="header">
        <div class="hdr-label squad">SQUAD</div>
        <div class="hdr-label finish">FINISH</div>
        <div class="hdr-label alive">ALIVE</div>
      </div>
      <!-- Rows list -->
      <div id="rows" class="rows"></div>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDIO3wksMFhs4j8FzI9VwTX_4sGJ1r12-0",
      authDomain: "team-overlay.firebaseapp.com",
      databaseURL: "https://team-overlay-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "team-overlay",
      storageBucket: "team-overlay.appspot.com",
      messagingSenderId: "751537440201",
      appId: "1:751537440201:web:ee16879d25632d4bb1d418"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const overlayRoot = document.getElementById('overlayRoot');
    const rowsEl = document.getElementById('rows');

    // Toggle visibility with stagger OUT/IN
    db.ref('overlayVisible').on('value', snap => {
      const visible = !!snap.val();
      if (visible) {
        overlayRoot.style.display = 'block';
        // stagger in current rows
        Array.from(rowsEl.children).forEach((row, i) => {
          row.classList.remove('exit');
          row.style.setProperty('--d', (i * 80) + 'ms');
          row.classList.add('enter');
        });
      } else {
        // stagger out then hide root
        const list = Array.from(rowsEl.children);
        let done = 0;
        const N = list.length;
        list.forEach((row, i) => {
          row.classList.remove('enter');
          row.style.setProperty('--d', ((N - 1 - i) * 80) + 'ms');
          row.classList.remove('changed');
          row.classList.add('exit');
          row.addEventListener('animationend', () => {
            done++;
            if (done === list.length) overlayRoot.style.display = 'none';
          }, { once:true });
        });
        if (!list.length) overlayRoot.style.display = 'none';
      }
    });

    // Fit rows to the native size of assets/wood.png (no zoom/crop)
    (function fitWoodToNative(){
      const img = new Image();
      img.onload = () => {
        const w = img.naturalWidth;
        const h = img.naturalHeight;
        document.documentElement.style.setProperty('--row-w', w + 'px');
        document.documentElement.style.setProperty('--row-h', h + 'px');
        document.documentElement.style.setProperty('--shift-x', (w - 366) + 'px');
        rowsEl.style.width = w + 'px';
      };
      img.src = 'assets/wood.png';
    })();

    const ICONS = {
      alive: "https://alive-status-new-m1la.vercel.app/assets/alive-yellow.png",
      dead:  "https://alive-status-new-m1la.vercel.app/assets/eliminated-red.png"
    };
    function makeIcons(aliveCount=0){
      const arr = [];
      for(let i=0;i<4;i++){ arr.push(i < (aliveCount||0) ? ICONS.alive : ICONS.dead); }
      return arr;
    }

    const SHOW_RANK = false;
    let lastMap = new Map(); // key -> { rowEl, signature }

    function rowHtml(team, idx, changed){
      const contentAnim = changed ? '' : '';
      return `
        <img class="wood-bg" src="assets/wood.png" alt="wood">
        <div class="team-content" ${contentAnim}>
          ${SHOW_RANK ? `<div class="rank">${idx+1}</div>` : ''}
          <img class="team-logo" src="${team.logo||''}" onerror="this.style.display='none'">
          <div class="team-name">${(team.name||'').toString()}</div>
          <div class="kills">${team.kills||0}</div>
          <div class="status-icons">
            ${makeIcons(team.aliveCount||0).map(src=>`<img src="${src}" alt="">`).join('')}
          </div>
        </div>`;
    }

    function render(data){
      const teams = Object.values(data || {});
      const aliveTeams = teams.filter(t => (t.aliveCount||0) > 0);
      const eliminatedTeams = teams.filter(t => (t.aliveCount||0) === 0);

      aliveTeams.sort((a,b)=> (b.kills||0)-(a.kills||0) || (b.aliveCount||0)-(a.aliveCount||0));
      eliminatedTeams.sort((a,b)=> (b.kills||0)-(a.kills||0));
      const sorted = [...aliveTeams, ...eliminatedTeams].slice(0,16);

      // Build new order and map existing elements by key
      const newKeys = sorted.map((t,i)=> (t.name||('team'+i)));
      const existing = new Map(Array.from(rowsEl.children).map(el => [el.dataset.key, el]));

      // Mark exits for rows no longer present
      let exitIndex = 0;
      existing.forEach((el, key) => {
        if (!newKeys.includes(key)){
          el.style.setProperty('--d', (exitIndex++ * 80) + 'ms');
          el.classList.remove('enter');
          el.classList.remove('changed');
          el.classList.add('exit');
          el.addEventListener('animationend', () => el.remove(), { once:true });
        }
      });

      // Create/Update rows in the new order with staggered ENTER
      // rowsEl.innerHTML = ''; // (disabled to prevent re-inserting all rows)
      const newMap = new Map();
      sorted.forEach((team, i) => {
        const key = team.name || ('team'+i);
        const signature = (team.kills||0) + '|' + (team.aliveCount||0);
        const prev = lastMap.get(key);
        let rowEl;

        if (prev){
          rowEl = prev.rowEl;
          const changed = prev.signature != signature;
          rowEl.innerHTML = rowHtml(team, i, changed);
          rowEl.classList.remove('exit');
          rowEl.classList.remove('enter'); if (changed) {
  rowEl.classList.add('changed');
  const content = rowEl.querySelector('.team-content');
  if (content) content.addEventListener('animationend', () => rowEl.classList.remove('changed'), { once: true });
} else {
  rowEl.classList.remove('changed');
}
// prevent re-triggering enter on updates
        } else {
          rowEl = document.createElement('div');
          rowEl.className = 'team enter';
          rowEl.innerHTML = rowHtml(team, i, true);
          // remove 'enter' after first animation completes
          rowEl.addEventListener('animationend', () => rowEl.classList.remove('enter'), { once:true });
        }
        rowEl.dataset.key = key;
        rowEl.style.setProperty('--d', (i * 80) + 'ms'); // stagger IN
        rowsEl.appendChild(rowEl);
        newMap.set(key, { rowEl, signature });
      });

      lastMap = newMap;
    }

    db.ref('teams').on('value', snap => render(snap.val()));
  </script>
</body>
</html>
