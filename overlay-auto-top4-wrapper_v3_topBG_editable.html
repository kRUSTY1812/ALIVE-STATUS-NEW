<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Wrapper v3: Top-4 with Provided BG + Editable Positions/Sizes</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  /* ======= EASY CONTROLS (edit these) ======= */
  :root{
    /* Overall popup scale (shrinks/grows everything uniformly) */
    --top4-scale: 0.92;      /* 1 = original size */

    /* Card background/base size (auto-set from BG image on load; you can override) */
    --card-w: 340px;         /* BG natural width if known */
    --card-h: 164px;         /* BG natural height if known */
    --card-gap: 10px;        /* gap between cards */

    /* Content placement INSIDE each card (pixels from card's top-left) */
    --logo-x: 18px;          /* logo position */
    --logo-y: 32px;
    --name-x: 110px;         /* team name position */
    --name-y: 40px;
    --icons-x: 110px;        /* alive icons position (first icon) */
    --icons-y: 78px;

    /* Sizes */
    --logo-size: 56px;
    --name-size: 22px;
    --name-width: 210px;     /* max width before ellipsis */
    --icons-size: 18px;      /* each icon w/h */
    --icons-gap: 6px;

    /* Text alignment for name: left | center | right */
    --name-align: left;
  }

  html,body{margin:0;padding:0;background:transparent;overflow:hidden;width:100%;height:100%;font-family:'Montserrat',sans-serif}
  .stage{position:relative;width:1920px;height:1080px;background:transparent}

  /* Keep original Alive Status untouched */
  #aliveFrame{position:absolute;left:0;top:0;width:1920px;height:1080px;border:0;z-index:10;background:transparent}

  /* Top-4 popup */
  #top4Panel{
    position:absolute;left:50%;top:50px;transform:translateX(-50%) scale(var(--top4-scale));transform-origin:top center;
    display:none;pointer-events:none;z-index:20;
    /* width is set dynamically from JS so it fits N cards in one row */
  }
  #top4Wrap{
    display:grid;justify-content:center;align-items:center;gap:var(--card-gap);
    grid-auto-flow:column; /* keep in one row when width permits */
  }

  .top-card{
    position:relative;width:var(--card-w);height:var(--card-h);
    display:block; /* absolute children handle layout */
    transition: transform 220ms cubic-bezier(.2,.9,.2,1), opacity 220ms ease;
    will-change: transform, opacity;
  }
  .top-bg{position:absolute;inset:0;width:100%;height:100%;object-fit:fill;pointer-events:none}
  .top-inner{position:absolute;left:0;top:0;width:100%;height:100%}

  .top-logo{
    position:absolute;left:var(--logo-x);top:var(--logo-y);
    width:var(--logo-size);height:var(--logo-size);object-fit:contain;
    filter:drop-shadow(0 2px 2px rgba(0,0,0,.35));
  }
  .top-name{
    position:absolute;left:var(--name-x);top:var(--name-y);
    font-weight:700;font-size:var(--name-size);color:#fff;text-transform:uppercase;
    width:var(--name-width);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    text-align:var(--name-align);
  }
  .top-icons{position:absolute;left:var(--icons-x);top:var(--icons-y);display:flex;gap:var(--icons-gap)}
  .top-icons img{width:var(--icons-size);height:var(--icons-size)}

  /* Enter/Exit + change animations (non-intrusive) */
  .enter{opacity:0;transform:translateY(-14px)}
  .enter.enter-active{opacity:1;transform:translateY(0)}
  .out{opacity:1}
  .out.out-active{opacity:0;transform:translateY(-14px)}
  @keyframes changedPulse{0%{transform:translateY(-4px)}100%{transform:translateY(0)}}
  .changed .top-inner{animation:changedPulse 280ms cubic-bezier(.16,1,.3,1)}

  .hidden{display:none!important}
</style>
</head>
<body>
  <div class="stage">
    <!-- Your original alive overlay loaded untouched -->
    <iframe id="aliveFrame" src="alive-status-stagger-anim_v2_rowChangeOnly_fix7_outReversed_smoothChange_deadOverlay_noChangeAnim.html"></iframe>

    <!-- Top-4 popup layer -->
    <div id="top4Panel"><div id="top4Wrap"></div></div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDIO3wksMFhs4j8FzI9VwTX_4sGJ1r12-0",
      authDomain: "team-overlay.firebaseapp.com",
      databaseURL: "https://team-overlay-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "team-overlay",
      storageBucket: "team-overlay.appspot.com",
      messagingSenderId: "751537440201",
      appId: "1:751537440201:web:ee16879d25632d4bb1d418"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const aliveFrame = document.getElementById('aliveFrame');
    const top4Panel  = document.getElementById('top4Panel');
    const top4Wrap   = document.getElementById('top4Wrap');

    /* Assets */
    const BG_CANDIDATES = ['TOP 5 BG.png','assets/TOP 5 BG.png'];
    const ICONS = {
      alive: "https://alive-status-new-m1la.vercel.app/assets/alive-yellow.png",
      dead:  "https://alive-status-new-m1la.vercel.app/assets/eliminated-red.png"
    };

    // Resolve BG path and set --card-w/--card-h from natural size
    (function resolveBG(){
      function tryLoad(i){
        if(i>=BG_CANDIDATES.length){ return; }
        const img = new Image();
        img.onload = () => {
          document.documentElement.style.setProperty('--card-w', img.naturalWidth+'px');
          document.documentElement.style.setProperty('--card-h', img.naturalHeight+'px');
          window.__TOP_BG__ = BG_CANDIDATES[i];
          // Also set initial panel width for 4 cards
          updatePanelWidth(4);
        };
        img.onerror = () => tryLoad(i+1);
        img.src = BG_CANDIDATES[i];
      }
      tryLoad(0);
    })();

    function makeIcons(aliveCount=0){
      const arr=[]; for(let i=0;i<4;i++){ arr.push(i < (aliveCount||0) ? ICONS.alive : ICONS.dead); } return arr;
    }

    /* Grid helpers */
    function cssNum(v){ return parseFloat(getComputedStyle(document.documentElement).getPropertyValue(v)) || 0; }
    function updatePanelWidth(cols){
      const w = cssNum('--card-w') * cols + cssNum('--card-gap') * (cols-1);
      top4Panel.style.width = w + 'px';
    }

    let topColumns = 4;
    let cardState = new Map();
    const getSig = (t)=>`${t.aliveCount||0}|${t.kills||0}|${t.name||''}|${t.logo||''}`;

    function setColumns(n){
      top4Wrap.style.gridTemplateColumns = `repeat(${Math.max(1,n)}, var(--card-w))`;
      updatePanelWidth(n);
      topColumns=n;
    }
    setColumns(4);

    function showTop4(){ aliveFrame.classList.add('hidden'); top4Panel.style.display='block'; }
    function showAlive(){ top4Panel.style.display='none'; aliveFrame.classList.remove('hidden'); }

    function flipMove(elementsBefore){
      requestAnimationFrame(()=>{
        elementsBefore.forEach((rectBefore, key)=>{
          const el = Array.from(top4Wrap.children).find(c=>c.dataset.key===key);
          if(!el || el.classList.contains('enter') || el.classList.contains('out')) return;
          const rectAfter = el.getBoundingClientRect();
          const dx = rectBefore.left - rectAfter.left;
          const dy = rectBefore.top  - rectAfter.top;
          if(Math.abs(dx)||Math.abs(dy)){
            el.style.transition = 'none';
            el.style.transform = `translate(${dx}px, ${dy}px)`;
            requestAnimationFrame(()=>{
              el.style.transition = 'transform 220ms cubic-bezier(.2,.9,.2,1)';
              el.style.transform = 'translate(0,0)';
            });
          }
        });
      });
    }

    function renderTop4(aliveTeams){
      const top = [...aliveTeams]
        .sort((a,b)=>(b.aliveCount||0)-(a.aliveCount||0) || (b.kills||0)-(a.kills||0))
        .slice(0,4);

      const newKeys = top.map(t=>t.name||'');
      const beforeRects = new Map();
      Array.from(top4Wrap.children).forEach(el=>beforeRects.set(el.dataset.key, el.getBoundingClientRect()));

      const toExit = Array.from(top4Wrap.children).filter(el => !newKeys.includes(el.dataset.key));
      let pendingExits = toExit.length;
      const newCols = Math.max(1, top.length);
      const delayCols = newCols < topColumns && pendingExits>0;

      toExit.forEach(el=>{
        el.classList.add('out');
        requestAnimationFrame(()=> el.classList.add('out-active'));
        el.addEventListener('transitionend', ()=>{
          el.remove();
          pendingExits--;
          if(delayCols && pendingExits===0){ setColumns(newCols); }
        }, { once:true });
      });

      top.forEach((t, i)=>{
        const key = t.name||`team${i}`;
        let card = Array.from(top4Wrap.children).find(el=>el.dataset.key===key);
        const prevSig = cardState.get(key);
        const sig = getSig(t);

        if(!card){
          card = document.createElement('div');
          card.className = 'top-card enter';
          card.dataset.key = key;
          const bgSrc = window.__TOP_BG__ || BG_CANDIDATES[0];
          card.innerHTML = `
            <img class="top-bg" src="${bgSrc}">
            <div class="top-inner">
              <img class="top-logo" src="${t.logo||''}" onerror="this.style.display='none'">
              <div class="top-name">${(t.name||'').toString()}</div>
              <div class="top-icons">
                ${makeIcons(t.aliveCount||0).map(s=>`<img src="${s}">`).join('')}
              </div>
            </div>`;
          top4Wrap.appendChild(card);
          requestAnimationFrame(()=>{
            card.classList.add('enter-active');
            card.addEventListener('transitionend', ()=>{
              card.classList.remove('enter','enter-active');
            }, { once:true });
          });
        }else{
          const changed = prevSig !== sig;
          if(changed){
            const nameEl = card.querySelector('.top-name');
            const logoEl = card.querySelector('.top-logo');
            const iconsEl = card.querySelector('.top-icons');
            if(nameEl && nameEl.textContent !== (t.name||'')) nameEl.textContent = (t.name||'');
            if(logoEl && logoEl.src !== (t.logo||'')) logoEl.src = (t.logo||'');
            if(iconsEl){
              const want = makeIcons(t.aliveCount||0);
              const imgs = Array.from(iconsEl.children);
              for(let i=0;i<4;i++){
                if(imgs[i]){
                  if(imgs[i].src !== want[i]) imgs[i].src = want[i];
                }else{
                  const im = document.createElement('img'); im.src = want[i]; iconsEl.appendChild(im);
                }
              }
            }
            card.classList.add('changed');
            card.addEventListener('animationend', ()=>card.classList.remove('changed'), { once:true });
          }
          top4Wrap.appendChild(card);
        }
        cardState.set(key, sig);
      });

      if(newCols > topColumns){ setColumns(newCols); }  // expand immediately
      flipMove(beforeRects);
    }

    function computeAliveTeams(teams){
      const arr = Object.values(teams||{});
      return arr.filter(t => (t.aliveCount||0) > 0);
    }

    let overlayToggle = true;
    db.ref('overlayVisible').on('value', s=>{
      overlayToggle = (s.val() !== false);
      if(!overlayToggle){ top4Panel.style.display='none'; aliveFrame.classList.add('hidden'); }
      else if(lastAliveCount>4){ showAlive(); }
      else if(lastAliveCount>0){ showTop4(); }
    });

    let lastAliveCount = 999;
    db.ref('teams').on('value', snap=>{
      const aliveTeams = computeAliveTeams(snap.val());
      if(!overlayToggle){ return; }
      if(aliveTeams.length>0 && aliveTeams.length<=4){ renderTop4(aliveTeams); showTop4(); }
      else{ showAlive(); }
      lastAliveCount = aliveTeams.length;
    });
  </script>
</body>
</html>
