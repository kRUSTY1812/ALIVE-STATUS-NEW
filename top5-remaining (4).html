<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Top 5 Teams Remaining â€” WWCD %</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700;800&display=swap" rel="stylesheet">

  <style>
    /* ===================== QUICK EDIT ZONE ===================== */
    :root{
      --stage-w: 1920px;
      --stage-h: 1080px;

      /* Strip position */
      --container-top: 100px;
      --container-left: 50%;
      --container-translate-x: -50%;

      /* Spacing */
      --gap-x: 56px;

      /* Background size */
      --card-w: 340px;
      --card-h: 164px;

      /* Font */
      --font-family: 'Montserrat', sans-serif;
      --name-color: #EAC278;

      /* NAME box */
      --name-left: 98px;
      --name-top: 78px;
      --name-width: 200px;
      --name-align: left;
      --name-size: 28px;
      --name-weight: 800;

      /* % tag */
      --pct-left: 50%;
      --pct-top: 12px;
      --pct-translate-x: -50%;
      --pct-size: 22px;
      --pct-weight: 800;
      --pct-color: #FBE7E7;

      /* Logo box */
      --logo-left: 38px;
      --logo-top: 74px;
      --logo-w: 46px;
      --logo-h: 46px;

      /* Animations */
      --in-duration: 420ms;
      --out-duration: 380ms;
      --stagger: 80ms;
    }

    /* Optional per-slot overrides */
    .slot1{} .slot2{} .slot3{} .slot4{} .slot5{}

    /* ===================== LAYOUT ===================== */
    html, body { margin:0; padding:0; background:transparent; overflow:hidden; }
    body { font-family: var(--font-family); }

    .stage{ position:relative; width:var(--stage-w); height:var(--stage-h); }
    .top5{
      position:absolute; top:var(--container-top); left:var(--container-left);
      transform:translateX(var(--container-translate-x));
      display:flex; align-items:flex-start; gap:var(--gap-x);
    }

    .card{
      position:relative; width:var(--card-w); height:var(--card-h);
      filter: drop-shadow(0 6px 20px rgba(0,0,0,.35));
      will-change: transform, opacity, filter;
    }
    .bg{ position:absolute; inset:0; width:100%; height:100%; object-fit:contain; pointer-events:none; }

    .pct{
      position:absolute; top:var(--pct-top); left:var(--pct-left); transform:translateX(var(--pct-translate-x));
      font-weight:var(--pct-weight); font-size:var(--pct-size); color:var(--pct-color);
      letter-spacing:1px; text-shadow:0 1px 0 rgba(0,0,0,.25); text-align:center; min-width:72px;
    }
    .logo{
      position:absolute; left:var(--logo-left); top:var(--logo-top);
      width:var(--logo-w); height:var(--logo-h); object-fit:contain;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,.45));
    }
    .name{
      position:absolute; left:var(--name-left); top:var(--name-top); width:var(--name-width);
      font-weight:var(--name-weight); font-size:var(--name-size); color:var(--name-color);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis; text-transform:uppercase; letter-spacing:.6px;
      text-align:var(--name-align);
    }

    /* ===================== ANIMATIONS ===================== */
    @keyframes enter { from{ opacity:0; transform:translateY(18px) } to{ opacity:1; transform:none } }
    @keyframes leave { from{ opacity:1; transform:none } to{ opacity:0; transform:translateY(-18px) } }
    @keyframes bump  { 0%{ transform:translateY(0) } 40%{ transform:translateY(-6px) } 100%{ transform:translateY(0) } }
    @keyframes flash { from{ filter:brightness(1.35) } to{ filter:brightness(1) } }

    .adding   { animation: enter var(--in-duration) cubic-bezier(.16,1,.3,1) both; }
    .removing { animation: leave var(--out-duration) cubic-bezier(.4,0,.8,.6) both; }

    /* Only animate the card whose own values changed */
    .bumpCard { animation: bump .45s ease-out; }
    .flashPct { animation: flash .35s ease-out; }
    .flashName{ animation: flash .35s ease-out; }

    .hidden{ display:none !important; }
  </style>
</head>
<body>
  <div id="stage" class="stage">
    <div id="top5" class="top5"></div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDIO3wksMFhs4j8FzI9VwTX_4sGJ1r12-0",
      authDomain: "team-overlay.firebaseapp.com",
      databaseURL: "https://team-overlay-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "team-overlay",
      storageBucket: "team-overlay.appspot.com",
      messagingSenderId: "751537440201",
      appId: "1:751537440201:web:ee16879d25632d4bb1d418"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const container = document.getElementById('top5');
    const slots = Array.from({length:5}, (_,i)=>{
      const el = document.createElement('div');
      el.className = 'card slot' + (i+1);
      el.innerHTML = `
        <img class="bg" src="assets/TOP 5 BG.png" alt="bg">
        <div class="pct">0.00 %</div>
        <img class="logo" src="" alt="">
        <div class="name"></div>
      `;
      container.appendChild(el);
      return el;
    });

    // Keep previous values per team (by name key)
    const prevByKey = new Map();
    let prevOrder = []; // previous top keys in order

    function roundTo100TwoDecimals(values){
      const scaled = values.map(v => Math.floor(v*100));
      const sum = scaled.reduce((a,b)=>a+b,0);
      let diff = 10000 - sum;
      const idx = values.map((v,i)=>({i,r:v*100 - Math.floor(v*100)})).sort((a,b)=>b.r-a.r);
      for(let k=0; diff>0 && k<idx.length; k++){ scaled[idx[k].i] += 1; diff--; }
      return scaled.map(v => (v/100).toFixed(2));
    }

    function apply(team, slotEl, pctString){
      // Fill text/images
      slotEl.querySelector('.pct').textContent = pctString + ' %';
      const logo = slotEl.querySelector('.logo');
      logo.src = team.logo || ''; logo.style.display = team.logo ? 'block' : 'none';
      slotEl.querySelector('.name').textContent = (team.name || '').toString();
    }

    function addOnce(el, cls, dur=600){
      el.classList.add(cls);
      setTimeout(()=> el.classList.remove(cls), dur);
    }

    function render(teamsObj){
      const allTeams = Object.values(teamsObj || {});
      const alive = allTeams.filter(t => (t.aliveCount||0) > 0);

      // sort & slice
      alive.sort((a,b)=>
        (b.aliveCount||0)-(a.aliveCount||0) ||
        (b.kills||0)-(a.kills||0) ||
        (a.name||'').localeCompare(b.name||'')
      );
      const top = alive.slice(0,5);
      const totalAlive = top.reduce((s,t)=> s + (t.aliveCount||0), 0);
      const rawPct = totalAlive>0 ? top.map(t => (t.aliveCount||0)/totalAlive*100) : top.map(_=>0);
      const pctArr = roundTo100TwoDecimals(rawPct);

      // keys in current order
      const keys = top.map(t => t.name || '');

      // Animate removals for any trailing slots that no longer have teams
      for(let i=top.length; i<5; i++){
        const slot = slots[i];
        if(!slot.classList.contains('hidden')){
          addOnce(slot, 'removing', 400);
          setTimeout(()=> slot.classList.add('hidden'), 380);
        }
      }

      // Fill visible slots & animate only when THIS team's values changed
      for(let i=0; i<top.length; i++){
        const t = top[i];
        const key = keys[i];
        const slot = slots[i];

        const wasHidden = slot.classList.contains('hidden');
        slot.classList.remove('hidden');

        const prev = prevByKey.get(key) || {};
        const aliveChanged = (prev.aliveCount ?? null) !== (t.aliveCount ?? null);
        const killsChanged = (prev.kills ?? null) !== (t.kills ?? null);
        const nameChanged  = (prev.name ?? '') !== (t.name ?? '');
        const logoChanged  = (prev.logo ?? '') !== (t.logo ?? '');

        // First time this team is visible OR slot was hidden -> enter animation
        const isNewTeamInTop = !prevOrder.includes(key);
        if(isNewTeamInTop || wasHidden){
          addOnce(slot, 'adding', 450);
        }

        // Apply content
        apply(t, slot, pctArr[i]);

        // Only animate this card if ITS OWN core values changed
        if(aliveChanged || killsChanged){
          addOnce(slot, 'bumpCard', 500);
          addOnce(slot.querySelector('.pct'), 'flashPct', 400);
        }
        if(nameChanged){
          addOnce(slot.querySelector('.name'), 'flashName', 400);
        }
        // (Logo change -> no text flash; visual change is enough)

        // Save prev for this team
        prevByKey.set(key, {aliveCount: t.aliveCount||0, kills: t.kills||0, name: t.name||'', logo: t.logo||''});
      }

      prevOrder = keys.slice();
    }

    // Show by default; hide only if explicitly set to false
    db.ref('top5Visible').on('value', snap => {
      const v = snap.val();
      document.getElementById('stage').style.display = (v === false) ? 'none' : 'block';
    });

    db.ref('teams').on('value', snap => render(snap.val()));
  </script>
</body>
</html>
