<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Wrapper: Keep Alive Status Untouched + Auto Top-4 Popup</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  html,body{margin:0;padding:0;background:transparent;overflow:hidden;width:100%;height:100%;font-family:'Montserrat',sans-serif}
  .stage{position:relative;width:1920px;height:1080px;background:transparent}
  /* Keep the original alive status exactly as-is by loading it in an iframe */
  #aliveFrame{position:absolute;left:0;top:0;width:1920px;height:1080px;border:0;z-index:10;background:transparent}
  /* Top-4 popup layered above */
  #top4Panel{position:absolute;left:50%;transform:translateX(-50%);top:50px;width:1300px;display:none;pointer-events:none;z-index:20}
  #top4Wrap{display:grid;justify-content:center;align-items:center;gap:12px}
  .top-card{
    position:relative;height:120px;border-radius:10px;background:#4b2a78;
    display:flex;align-items:center;padding:12px 16px;box-sizing:border-box;
    opacity:0;transform:translateY(-14px);animation:topIn .35s cubic-bezier(.2,.9,.2,1) forwards
  }
  .top-logo{width:64px;height:64px;object-fit:contain;margin-right:14px;filter:drop-shadow(0 2px 2px rgba(0,0,0,.35))}
  .top-meta{display:flex;flex-direction:column;gap:6px}
  .top-name{font-weight:700;font-size:24px;color:#fff;text-transform:uppercase;max-width:260px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .top-icons{display:flex;gap:6px}
  .top-icons img{width:22px;height:22px}
  @keyframes topIn{to{opacity:1;transform:translateY(0)}}
  @keyframes topOut{to{opacity:0;transform:translateY(-14px)}}
  .top-card.out{animation:topOut .25s ease-in forwards}
  .hidden{display:none!important}
</style>
</head>
<body>
  <div class="stage">
    <!-- Your original file is loaded untouched here -->
    <iframe id="aliveFrame" src="alive-status-stagger-anim_v2_rowChangeOnly_fix7_outReversed_smoothChange_deadOverlay_noChangeAnim.html"></iframe>

    <!-- Auto Top-4 popup -->
    <div id="top4Panel">
      <div id="top4Wrap"></div>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDIO3wksMFhs4j8FzI9VwTX_4sGJ1r12-0",
      authDomain: "team-overlay.firebaseapp.com",
      databaseURL: "https://team-overlay-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "team-overlay",
      storageBucket: "team-overlay.appspot.com",
      messagingSenderId: "751537440201",
      appId: "1:751537440201:web:ee16879d25632d4bb1d418"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const aliveFrame = document.getElementById('aliveFrame');
    const top4Panel  = document.getElementById('top4Panel');
    const top4Wrap   = document.getElementById('top4Wrap');

    /* Icons – same look as your Alive Status */
    const ICONS = {
      alive: "https://alive-status-new-m1la.vercel.app/assets/alive-yellow.png",
      dead:  "https://alive-status-new-m1la.vercel.app/assets/eliminated-red.png"
    };
    function makeIcons(aliveCount=0){
      const arr=[]; for(let i=0;i<4;i++){ arr.push(i < (aliveCount||0) ? ICONS.alive : ICONS.dead); } return arr;
    }

    /* Build Top-4 cards (auto reflow to 4→3→2→1) */
    function renderTop4(aliveTeams){
      const top = [...aliveTeams]
        .sort((a,b)=>(b.aliveCount||0)-(a.aliveCount||0) || (b.kills||0)-(a.kills||0))
        .slice(0,4);

      const newKeys = new Set(top.map(t=>t.name||''));
      Array.from(top4Wrap.children).forEach(el=>{
        if(!newKeys.has(el.dataset.key)){
          el.classList.add('out');
          el.addEventListener('animationend',()=>el.remove(),{once:true});
        }
      });

      const n = Math.max(1, top.length);
      top4Wrap.style.gridTemplateColumns = `repeat(${n}, 1fr)`;

      top.forEach((t,i)=>{
        const key = t.name||`team${i}`;
        let card = Array.from(top4Wrap.children).find(el=>el.dataset.key===key);
        const html = `
          <img class="top-logo" src="${t.logo||''}" onerror="this.style.display='none'">
          <div class="top-meta">
            <div class="top-name">${(t.name||'').toString()}</div>
            <div class="top-icons">
              ${makeIcons(t.aliveCount||0).map(s=>`<img src="${s}">`).join('')}
            </div>
          </div>`;
        if(!card){
          card = document.createElement('div');
          card.className = 'top-card';
          card.dataset.key = key;
          card.style.animationDelay = (i*80)+'ms';
        }else{
          card.classList.remove('out');
          card.innerHTML = '';
          card.style.animationDelay = (i*80)+'ms';
        }
        card.innerHTML = html;
        top4Wrap.appendChild(card);
      });
    }

    /* Visibility switching without touching the inner file */
    function showTop4(){ aliveFrame.classList.add('hidden'); top4Panel.style.display='block'; }
    function showAlive(){ top4Panel.style.display='none'; aliveFrame.classList.remove('hidden'); }

    let overlayToggle = true; // optional /overlayVisible switch
    db.ref('overlayVisible').on('value', s=>{
      overlayToggle = (s.val() !== false);
      if(!overlayToggle){ top4Panel.style.display='none'; aliveFrame.classList.add('hidden'); }
      else if(aliveCountCache>4){ showAlive(); }
      else if(aliveCountCache>0){ showTop4(); }
    });

    let aliveCountCache = 999;
    db.ref('teams').on('value', snap=>{
      const teams = Object.values(snap.val()||{});
      const aliveTeams = teams.filter(t => (t.aliveCount||0) > 0);

      renderTop4(aliveTeams);

      if(!overlayToggle){ return; }
      aliveCountCache = aliveTeams.length;
      if(aliveTeams.length>0 && aliveTeams.length<=4){ showTop4(); }
      else { showAlive(); }
    });
  </script>
</body>
</html>
